services:
  # Database for testing (isolated, in-memory)
  postgres:
    environment:
      POSTGRES_DB: test_db
      POSTGRES_PASSWORD: testpass
    tmpfs:
      - /var/lib/postgresql/data # Runs in RAM for speed and cleanup
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U taskuser -d test_db" ]
      interval: 2s
      timeout: 2s
      retries: 5

  # Tasks Service Test Configuration
  tasks-service:
    build:
      target: dev
    environment:
      - NODE_ENV=test
      - DATABASE_URL=postgresql://taskuser:testpass@postgres:5432/test_db
    command: [ "npm", "run", "test" ] # Overrides the default dev command
    depends_on:
      postgres:
        condition: service_healthy

  # Stats Service Test Configuration
  stats-service:
    build:
      target: dev
    environment:
      - NODE_ENV=test
    command: [ "npm", "run", "test" ]

  # Disable services not needed for backend testing
  adminer:
    profiles: [ "donotstart" ]

  frontend:
    profiles: [ "donotstart" ]
