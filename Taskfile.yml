# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: '3'

vars:
  PORT: 3000
  DC_DEV: docker-compose -p dev -f docker-compose.yml -f docker-compose.override.yml
  DC_PROD: docker-compose -p prod -f docker-compose.yml -f docker-compose.prod.yml
  DC_TEST: docker-compose -p test -f docker-compose.yml -f docker-compose.test.yml
  NODE_SERVICES: tasks-service stats-service
  REGISTRY_URL: localhost:5000
  VERSION: 1.0.1

  DOCKER_SERVICES: tasks-service stats-service frontend

tasks:
  
  up:
    desc: Start development environment (alias for dev)
    cmds:
      - task: dev

  dev:
    desc: Start development environment (with hot-reload and logs)
    deps: [check-docker]
    cmds:
      - "{{.DC_DEV}} up -d --build --remove-orphans"
      - echo "Development environment started! (Project dev)"
      - task: logs

  build:
    desc: Build images for development explicitly
    deps: [check-docker]
    cmds:
      - "{{.DC_DEV}} build"

  docker:build:
    desc: Build images
    deps: [check-docker]
    cmds:
      - "{{.DC_DEV}} build {{.DOCKER_SERVICES}}"

  docker:tag:
    desc: Tag images for registry
    cmds:
      - for: { var: DOCKER_SERVICES, split: ' ' }
        cmd: docker tag {{.ITEM}}:latest {{.REGISTRY_URL}}/{{.ITEM}}:{{.VERSION}}

  docker:push:
    desc: Push images to local registry
    cmds:
      - for: { var: DOCKER_SERVICES, split: ' ' }
        cmd: docker push {{.REGISTRY_URL}}/{{.ITEM}}:{{.VERSION}}

  docker:
    desc: Build, tag, and push images
    cmds:
      - task: docker:build
      - task: docker:tag
      - task: docker:push
      - echo "âœ… Images pushed to {{.REGISTRY_URL}}"


  logs:
    desc: Follow logs
    cmds:
      - "{{.DC_DEV}} logs -f"

  install:
    desc: Install dependencies for all services
    cmds:
      - echo "ðŸ“¦ Installing dependencies..."
      - for: { var: NODE_SERVICES, split: ' ' }
        cmd: cd {{.ITEM}} && npm install
      - echo "âœ… Dependencies installed"

  test:
    desc: Lance tous les tests
    deps: [install]
    cmds:
      - echo "ðŸ§ª Lancement des tests..."
      - for: { var: NODE_SERVICES, split: ' ' }
        cmd: |
          echo "Testing {{.ITEM}}..."
          cd {{.ITEM}} && npm test
      - echo "âœ… Tous les tests sont passÃ©s"

  test:watch:
    desc: Lance les tests en mode watch
    cmds:
      - echo "ðŸ‘€ Mode watch activÃ© (Ctrl+C pour quitter)"
      - echo "Choisir le service tasks-service ou stats-service"
      - cd {{.CLI_ARGS}} && npm run test:watch

  test:service:
    desc: Test un service spÃ©cifique
    cmds:
      - echo "ðŸ§ª Test de {{.CLI_ARGS}}..."
      - cd {{.CLI_ARGS}} && npm test

  ci:
    desc: Pipeline CI complÃ¨te (install â†’ test â†’ build)
    cmds:
      - echo "ðŸš€ DÃ©marrage de la pipeline CI..."
      - task: install
      - task: test
      - task: build
      - task: docker
      - echo "âœ… Pipeline CI terminÃ©e avec succÃ¨s"

  clean-test:
    internal: true
    desc: Cleanup test environment
    cmds:
      - "{{.DC_TEST}} down -v --remove-orphans"

  prod:
    desc: Start production environment
    deps: [check-docker]
    cmds:
      - "{{.DC_PROD}} up -d --build --remove-orphans"
      - echo "Production environment started! (Project prod)"

  down:
    desc: Stop all containers and remove networks (dev project by default)
    cmds:
      - "{{.DC_DEV}} down --remove-orphans"
      - echo "ðŸ›‘ Development environment stopped"

  clean:
    desc: Fierce cleanup (containers, volumes, networks, and local images) for ALL projects
    prompt: "âš ï¸ This will delete ALL data (volumes) and local images for dev, prod AND test. Are you sure?"
    cmds:
      - "{{.DC_DEV}} down -v --rmi local --remove-orphans"
      - "{{.DC_TEST}} down -v --rmi local --remove-orphans"
      - "{{.DC_PROD}} down -v --rmi local --remove-orphans"
      - echo "ðŸ§¹ All environments fully cleaned"
      
  registry:clean:
    desc: Supprime toutes les images du registry
    cmds:
      - echo "âš ï¸ Suppression des images du registry..."
      - docker compose down registry
      - docker volume rm demo-projet-devops_registry-data || true
      - docker compose up -d registry
      - echo "âœ… Registry nettoyÃ©"

  check-docker:
    internal: true
    desc: Check if Docker daemon is running
    silent: true
    cmds:
      - 'docker info > /dev/null 2>&1 || (echo "ERREUR: Docker n est pas lance !" && exit 1)'
